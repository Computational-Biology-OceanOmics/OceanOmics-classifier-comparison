---
title: "Untitled"
output: html_document
date: "2023-09-27"
---
```{r}
library(tidyverse)
```

```{r}
data <- targets::tar_read(truth_set_data)
blast <- targets::tar_read(subsambled_blast_hits_data)
kraken <- targets::tar_read(subsambled_kraken_hits_data) |> filter(Kraken_confidence == 0.0)
kraken_0.1 <- targets::tar_read(subsambled_kraken_hits_data) |> filter(Kraken_confidence == 0.1)
nbc <- targets::tar_read(subsampled_nbc_hits_data) |> filter(Score > 0.95)
```


```{r}
data |> mutate(species = case_when(species != 'dropped' ~ 'OnSpeciesLevel',
                                   TRUE ~ 'OnGenusLevel')) |> 
  count(species)
```

```{r}
data
```

```{r}
blast |> right_join(data, by = c('Query','OTU'), suffix = c('Blast', 'Truth')) |> 
  select(speciesBlast, speciesTruth) |> 
  filter(speciesBlast != 'dropped',
         speciesTruth != 'dropped') |> 
  mutate(same = speciesBlast == speciesTruth) |> select(same) |> table()
```

True negatives:
```{r}
blast |> right_join(data, by = c('Query','OTU'), suffix = c('Blast', 'Truth')) |> 
  select(speciesBlast, speciesTruth) |> 
  filter(speciesBlast %in% c(NA, 'dropped'),
         speciesTruth == 'dropped')
```

false negatives:

```{r}

blast |> right_join(data, by = c('Query','OTU'), suffix = c('Blast', 'Truth')) |> 
  select(speciesBlast, speciesTruth) |> 
  filter(speciesBlast %in% c(NA, 'dropped'),
         speciesTruth != 'dropped')
```
```{r}
blast |> right_join(data, by = c('Query','OTU'), suffix = c('Blast', 'Truth')) |> nrow()
```

So we have 137 false negatives, 96 true positives, 13 false positives, 3 true negatives.

```{r}
blast_accuracy <- 96 / (249) 
blast_precision <- 96 / (96 + 13)
blast_recall <- 96 / (96 + 137)
blast_f1 <- 2 * (blast_precision * blast_recall) / (blast_precision + blast_recall)
```

# Kraken

For Kraken:

```{r}
kraken |> right_join(data, by = c('Query','OTU'), suffix = c('Kraken', 'Truth')) 
```
True positives, False positives:

```{r}
kraken |> right_join(data, by = c('Query','OTU'), suffix = c('Kraken', 'Truth')) |> 
  select(speciesKraken, speciesTruth) |> 
  filter(!is.na(speciesKraken),
         speciesTruth != 'dropped') |> 
  mutate(same = speciesKraken == speciesTruth) |> select(same) |> table()
```
True Negatives:

```{r}
kraken |> right_join(data, by = c('Query','OTU'), suffix = c('Kraken', 'Truth')) |> 
  select(speciesKraken, speciesTruth) |> 
  filter(is.na(speciesKraken),
         speciesTruth == 'dropped')
```
False negatives:

```{r}
kraken |> right_join(data, by = c('Query','OTU'), suffix = c('Kraken', 'Truth')) |> 
  select(speciesKraken, speciesTruth) |> 
  filter(is.na(speciesKraken),
         speciesTruth != 'dropped')
```

106 True positives, 29 False Positives, 3 true negatives, 111 false negatives


```{r}
kraken_accuracy <- 106 / (106+29+3+111) 
kraken_precision <- 106 / (106 + 29)
kraken_recall <- 106 / (106 + 111)
kraken_f1 <- 2 * (kraken_precision * kraken_recall) / (kraken_precision + kraken_recall)
```

# Kraken 0.1

True positives, False positives:

```{r}
kraken_0.1 |> right_join(data, by = c('Query','OTU'), suffix = c('Kraken', 'Truth')) |> 
  select(speciesKraken, speciesTruth) |> 
  filter(!is.na(speciesKraken),
         speciesTruth != 'dropped') |> 
  mutate(same = speciesKraken == speciesTruth) |> select(same) |> table()
```
True Negatives:

```{r}
kraken_0.1 |> right_join(data, by = c('Query','OTU'), suffix = c('Kraken', 'Truth')) |> 
  select(speciesKraken, speciesTruth) |> 
  filter(is.na(speciesKraken),
         speciesTruth == 'dropped')
```
False negatives:

```{r}
kraken_0.1 |> right_join(data, by = c('Query','OTU'), suffix = c('Kraken', 'Truth')) |> 
  select(speciesKraken, speciesTruth) |> 
  filter(is.na(speciesKraken),
         speciesTruth != 'dropped')
```

92 True positives, 15 False Positives, 3 true negatives, 139 false negatives


```{r}
kraken_0.1_accuracy <- 92 / (92+15+3+139) 
kraken_0.1_precision <- 92 / (92 + 15)
kraken_0.1_recall <- 92/ (92 + 139)
kraken_0.1_f1 <- 2 * (kraken_0.1_precision * kraken_0.1_recall) / (kraken_0.1_precision + kraken_0.1_recall)
```

# NBC


```{r}
nbc |>
  right_join(data, by = c('Query','OTU'), suffix = c('Kraken', 'Truth')) 
```
True positives, False positives:

```{r}
nbc |> right_join(data, by = c('Query','OTU'), suffix = c('NBC', 'Truth')) |> 
  select(speciesNBC, speciesTruth) |> 
  filter(!is.na(speciesNBC),
         speciesTruth != 'dropped') |> 
  mutate(same = speciesNBC == speciesTruth) |> select(same) |> table()
```
True Negatives:

```{r}
nbc |> right_join(data, by = c('Query','OTU'), suffix = c('NBC', 'Truth')) |> 
  select(speciesNBC, speciesTruth) |> 
  filter(is.na(speciesNBC),
         speciesTruth == 'dropped')
```
False negatives:

```{r}
nbc |> right_join(data, by = c('Query','OTU'), suffix = c('NBC', 'Truth')) |> 
  select(speciesNBC, speciesTruth) |> 
  filter(is.na(speciesNBC),
         speciesTruth != 'dropped')
```

96 True positives, 31 False Positives, 3 true negatives, 119 false negatives


```{r}
nbc_accuracy <- 96 / (96+31+3+119) 
nbc_precision <- 96 / (96 + 31)
nbc_recall <- 96 / (96 + 119)
nbc_f1 <- 2 * (nbc_precision * nbc_recall) / (nbc_precision + nbc_recall)
```

# summary

```{r}
df <- tibble(names = c('blast', 'kraken', 'kraken_0.1', 'nbc'), f1 = c(blast_f1, kraken_f1, kraken_0.1_f1, nbc_f1), recall = c(blast_recall, kraken_recall, kraken_0.1_recall, nbc_recall), accuracy = c(blast_accuracy, kraken_accuracy, kraken_0.1_accuracy, nbc_accuracy), precision = c(blast_precision, kraken_precision, kraken_0.1_precision, nbc_precision))
df
```

```{r}
df |> pivot_longer(-names, names_to = 'Measure', values_to='Score') |> 
  rename(Tool = names) |> 
  ggplot(aes(x = Measure,  color = Tool, fill = Tool, y = Score, group = Tool)) + geom_point() + geom_line() + 
  ylim(c(0, 1)) + theme_minimal() + theme(legend.position="bottom")
```

```{r}
kraken_0.1 |> right_join(data, by = c('Query','OTU'), suffix = c('Kraken_0.1', 'Truth')) |> 
  mutate(Type = str_replace(Type, 'Kraken', replacement = 'Kraken_0.1')) |> 
  right_join(kraken |> select(Query, OTU, species), by = c('Query', 'OTU')) |> 
  rename(species_Kraken = species) |> 
  right_join(blast |> select(Query, OTU, species), by = c('Query', 'OTU')) |> 
  rename(species_Blast = species) |> select(speciesTruth, speciesKraken_0.1, species_Kraken, species_Blast) |> 
  mutate(species_Blast = na_if(species_Blast, 'dropped'))
```

